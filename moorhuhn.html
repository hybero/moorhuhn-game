<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width" />
        <title>Moorhuhn Texas</title>
        <link rel="stylesheet" href="./css/styles.css">

        <script type="text/javascript" src="./js/lib/lodash.js"></script>
        <script type="text/javascript" src="./js/helpers/myhelpers.js"></script>

        <script type="text/javascript" src="./js/Landscape1.js"></script>
        <script type="text/javascript" src="./js/MoorhuhnFlying.js"></script>
        <script type="text/javascript" src="./js/Crosshair.js"></script>
        <script type="text/javascript" src="./js/Countdown.js"></script>
        <script type="text/javascript" src="./js/Score.js"></script>
        <script type="text/javascript" src="./js/Cactus.js"></script>
        <script type="text/javascript" src="./js/Ammo.js"></script>
        <script type="text/javascript" src="./js/SoundPool_2.js"></script>
        <script type="text/javascript" src="./js/Checkbox.js"></script>
    </head>
    <body>

        <canvas id="hra-moorhuhn"></canvas>


        <script type="text/javascript">

            var soundPool = new SoundPool();
            soundPool.init();

            // ziskanie contextu a bufferu
            var context = document.querySelector("canvas").getContext("2d");
            var buffer  = document.createElement("canvas").getContext("2d"); // zasobnik, najprv vykreslujeme tam, az potom do canvasu
            console.log(':::: context a buffer mame ::::');

            // zistime vysku sirku podla clienta (prehliadaca)
            var height = document.documentElement.clientHeight;
            var width = document.documentElement.clientWidth;

            var moorhuhns = {}; // mooorhuhny na vykreslenie
            var moorhuhnsSorted = []; // moorhuhny usporiadane podla velkosti na spravne vykreslenie prekryvania
            var moorhuhnAmountMax = 1; // maximum povolenych moorhuhnov na vykreslenie v dany moment v case, toto sa meni s beziacim casom
            var moorhuhnMax = 15; // maximum moorhuhnov na vykreslenie - toto je absolutny max, ktory sa neprekroci
            var moorhuhnK = 60; // do K si budeme ukladat koeficient pre zvysovanie poctu moorhuhnov exponencialne
            var id_log = 0; // log posledneho id moorhuhna
            var imagesLoaded = false;
            var stopAnimations = false; // pouziva sa pri game over // nebude sa pouzivat - kazdy objekt bude mat vlastny stav stopovania movementu a animacie
            var checkboxesCreated = false;

            var gameLoop_i = 0; // pocitame iteracie v hernom loope

            var pointer = { down:false, x:0, y:0 }; // cursor mysi

            const GAMESTATE = {
                INTRO: 0,
                MENU: 1,
                PAUSED: 2,
                RUNNING: 3,
                STOPPED: 4,
                ABOUT: 5,
                SETTINGS: 6,
                LEVEL_1: 7,
                GAME_OVER: 8
            };

            var gameState = GAMESTATE.INTRO;

            var SETTINGS = {
                FULLSCREEN: false,
                AUDIO: true
            };

            var PAUSED = false;

            // Tlacitka
            var buttons = {};

            function calcButtons() {
                buttons = {
                    size: height / 14,
                    heading: {
                        x: width/2,
                        y: height * 0.08, // 150
                        h: buttons.size * 1.3,
                        w: buttons.size * 20
                    },
                    menu: {
                        start: {
                            x: width/2,
                            cx: width/2 - buttons.size * 4.0 / 2,
                            y: height / 3 * 1, // 150
                            h: buttons.size,
                            w: buttons.size * 4.0
                        },
                        about: {
                            x: width/2,
                            cx: width/2 - buttons.size * 4.0 / 2,
                            y: height / 3 * 1.5, // 230
                            h: buttons.size,
                            w: buttons.size * 4.0,
                            b: {
                                back: {
                                    h: buttons.size,
                                    x: width/2,
                                    cx:width/2 - buttons.size * 3.3 / 2,
                                    y: height / 3 * 2.5, // 310
                                    w: buttons.size * 3.7
                                }
                            }
                        },
                        settings: {
                            x: width/2,
                            cx: width/2 - buttons.size * 4.5 / 2,
                            y: height / 3 * 2, // 310
                            h: buttons.size,
                            w: buttons.size * 4.5,
                            b: {
                                fullscreen: {
                                    h: buttons.size,
                                    x: width/2,
                                    cx:width/2 - buttons.size * 6.4,
                                    y: height / 3 * 1, // 310
                                    w: buttons.size * 6.4 + buttons.size * 4,
                                    bw: buttons.size * 0.8, // 0.8 - koeficient velkosti checkboxu oproti font size
                                    bh: buttons.size * 0.8,
                                    bx: width/2 + buttons.size * 3 + (1 - 0.8) / 2,
                                    by: height / 3 * 1 + (1 - 0.8) / 2
                                },
                                audio: {
                                    h: buttons.size,
                                    x: width/2,
                                    cx:width/2 - buttons.size * 4.0,
                                    y: height / 3 * 1.3, // 310
                                    w: buttons.size * 4.0 + buttons.size * 4,
                                    bw: buttons.size * 0.8, // 0.8 - koeficient velkosti checkboxu oproti font size
                                    bh: buttons.size * 0.8,
                                    bx: width/2 + buttons.size * 3 + (1 - 0.8) / 2,
                                    by: height / 3 * 1.3 + (1 - 0.8) / 2
                                },
                                back: {
                                    h: buttons.size,
                                    x: width/2,
                                    cx:width/2 - buttons.size * 3.3 / 2,
                                    y: height / 3 * 2.5, // 310
                                    w: buttons.size * 3.7
                                }
                            }
                        }
                    },
                    game_over: {
                        continue: {
                            x: width/2,
                            cx: width/2 - buttons.size * 5.5 / 2,
                            y: height / 3 * 1.6,
                            h: buttons.size,
                            w: buttons.size * 5.5
                        }
                    }
                };
            }

            calcButtons();

            // Texty
            var texts = {};

            function calcTexts() {
                texts = {
                    about: {
                        key_bindings: {
                            esc: {
                                x: width * 0.34,
                                y: height / 4 * 1.0,
                                h: buttons.size * 0.5,
                                w: buttons.size * 5.5 // ! not used
                            },
                            esc_text:  {
                                x: width * 0.34,
                                y: height / 4 * 1.0 + buttons.size * 0.1 / 2,
                                h: buttons.size * 0.4,
                                w: buttons.size * 5.5 // ! not used
                            },
                            p: {
                               x: width * 0.34,
                               y: height / 4 * 1.2,
                               h: buttons.size * 0.5,
                               w: buttons.size * 5.5 // ! not used
                            },
                            p_text: {
                              x: width * 0.34,
                              y: height / 4 * 1.2 + buttons.size * 0.1 / 2,
                              h: buttons.size * 0.4,
                              w: buttons.size * 5.5 // ! not used
                            },
                            left_click: {
                               x: width * 0.34,
                               y: height / 4 * 1.4,
                               h: buttons.size * 0.5,
                               w: buttons.size * 5.5 // ! not used
                            },
                            left_click_text: {
                              x: width * 0.34,
                              y: height / 4 * 1.4 + buttons.size * 0.1 / 2,
                              h: buttons.size * 0.4,
                              w: buttons.size * 5.5 // ! not used
                            },
                            space: {
                               x: width * 0.34,
                               y: height / 4 * 1.6,
                               h: buttons.size * 0.5,
                               w: buttons.size * 5.5 // ! not used
                            },
                            space_text: {
                              x: width * 0.34,
                              y: height / 4 * 1.6 + buttons.size * 0.1 / 2,
                              h: buttons.size * 0.4,
                              w: buttons.size * 5.5 // ! not used
                            },
                            moorhuhn: {
                               x: width * 0.5 / 3 * 1 + ((width - width * 0.5) / 2) / 1.5, // 1/3
                               y: height / 4 * 1.9,
                               h: buttons.size * 0.5,
                               w: buttons.size * 5.5 // ! not used
                            },
                            moorhuhn_shot: {
                              x: width * 0.5 / 3 * 2 + ((width - width * 0.5) / 2) / 1.5, // 2/3
                              y: height / 4 * 1.9,
                              h: buttons.size * 0.5,
                              w: buttons.size * 5.5 // ! not used
                            },
                            magazine: {
                              x: width * 0.5 / 3 * 3 + ((width - width * 0.5) / 2) / 1.5, // 3/3
                              y: height / 4 * 1.9,
                              h: buttons.size * 0.5,
                              w: buttons.size * 5.5 // ! not used
                            }
                        }
                    }
                };
            }

            calcTexts();

            var colors = {
                color_active: '#FFA936',
                color_passive: '#FFE336'
            };

            // funkcia na loadnutie obrazka/obrazkov pre jeden objekt
            function loadImage(obj) {
                return new Promise((resolve, reject) => {
                    let img = new Image();
                    img.addEventListener("load", () => {
                        obj.img = img;
                        if (obj.hasOwnProperty('imgDeadSrc')) {
                            let imgDead = new Image();
                            imgDead.addEventListener("load", () => {
                                obj.imgDead = imgDead;
                                resolve(obj);
                            });
                            imgDead.addEventListener("error", (err) => {
                                reject(err);
                            });
                            imgDead.src = obj.imgDeadSrc;
                        }
                        resolve(obj);
                    });
                    img.addEventListener("error", (err) => {
                        reject(err);
                    });
                    img.src = obj.imgSrc;
                });
            }

            // vytvorime po jednom objekte z kazdeho typu pre jednorazove loadnutie obrazkov
            var landscape1 =  new Landscape1(0, 0);

            var moorhuhnFlyLeft = new MoorhuhnFlying('mfl', -1, context.canvas.width, context.canvas.height, './assets/graphics/Moorhuhn_L.png', './assets/graphics/Moorhuhn_L_zasah.png');
            // var moorhuhnFlyLeft = new MoorhuhnFlying('mfl', -1, context.canvas.width, context.canvas.height, './assets/graphics/Transparent_PNG/flying/flappy_L.png', './assets/graphics/Transparent_PNG/flying/flappy_L_hit.png');

            var moorhuhnFlyRight = new MoorhuhnFlying('mfr', 1, context.canvas.width, context.canvas.height, './assets/graphics/Moorhuhn_P.png', './assets/graphics/Moorhuhn_P_zasah.png');
            // var moorhuhnFlyRight = new MoorhuhnFlying('mfr', 1, context.canvas.width, context.canvas.height, './assets/graphics/Transparent_PNG/flying/flappy_R.png', './assets/graphics/Transparent_PNG/flying/flappy_R_hit.png');

            var moorhuhnTypes = [moorhuhnFlyLeft, moorhuhnFlyRight];

            var countdown = new Countdown(buffer, context);
            countdown.initTime();

            var score = new Score(buffer, context);
            score.initScore();

            var ammo = new Ammo(buffer, context);

            var crosshair = new Crosshair();

            var checkbox_c = new Checkbox('checked', true, buttons.size);

            var checkbox_u = new Checkbox('unchecked', false, buttons.size);

            // disablnutie right-cliku na canvase
            context.canvas.addEventListener('contextmenu', event => event.preventDefault());

            // zachytavanie pozicie mysi
            context.canvas.addEventListener('mousemove', function(event) {
                crosshair.updateMousePosition(event.clientX, event.clientY);
            });

            // zachytavanie clicku mysi
            context.canvas.addEventListener('mousedown', function(event) {
                switch (gameState) {
                    case GAMESTATE.INTRO:
                        gameState = GAMESTATE.MENU;
                        break;
                    case GAMESTATE.STOPPED:
                        continueClick(event.clientX, event.clientY);
                        break;
                    case GAMESTATE.MENU:
                        menuOnClick(event.clientX, event.clientY);
                        break;
                    case GAMESTATE.SETTINGS:
                        settingsOnClick(event.clientX, event.clientY);
                        break;
                    case GAMESTATE.ABOUT:
                        aboutOnClick(event.clientX, event.clientY);
                        break;
                    case GAMESTATE.PAUSED:
                        menuOnClick(event.clientX, event.clientY);
                        break;
                    case GAMESTATE.RUNNING:
                        shoot(event.clientX, event.clientY);
                        break;
                    default:
                        break;
                }
            });

            // Zachytenie eventu exit fullscreen
            document.addEventListener('fullscreenchange', exitFSHandler);
            document.addEventListener('webkitfullscreenchange', exitFSHandler);
            document.addEventListener('mozfullscreenchange', exitFSHandler);
            document.addEventListener('MSFullscreenChange', exitFSHandler);

            function exitFSHandler() {
                if (!document.fullscreenElement && !document.webkitIsFullScreen && !document.mozFullScreen && !document.msFullscreenElement) {
                    SETTINGS.FULLSCREEN = false;
                }
            }

            // zachytavanie stlacenie klavesy
            document.addEventListener('keyup', function(event) {
                if(gameState == GAMESTATE.INTRO) {
                    gameState = GAMESTATE.MENU;
                }

                // stlacenim ESC v About a Settings sa vrati do menu
                if(event.keyCode === 27 && (gameState == GAMESTATE.ABOUT || gameState == GAMESTATE.SETTINGS)) {
                    gameState = GAMESTATE.MENU;
                }

                // stlacenim medzernika sa zasobnik prebije
                if(event.keyCode === 32 && gameState == GAMESTATE.RUNNING) {
                    ammo.reloadMagazine();
                    soundPool.playReload();
                }

                // stlacenim P sa beziaca hra pauzne
                if(event.keyCode === 80) {
                    if(gameState === GAMESTATE.GAME_OVER) {
                        gameState = GAMESTATE.MENU;
                    }
                    if(gameState === GAMESTATE.RUNNING) {
                        pauseGame();
                    } else if(gameState === GAMESTATE.PAUSED || (gameState === GAMESTATE.MENU && PAUSED == true)) {
                        resumeGame();
                    } else if((gameState === GAMESTATE.ABOUT && PAUSED == true) || (gameState === GAMESTATE.SETTINGS && PAUSED == true)) {
                        resumeGame();
                    }
                }
            });

            // objekty za sebou v liste
            var objects = [landscape1, moorhuhnFlyLeft, moorhuhnFlyRight, crosshair, countdown, score, ammo, checkbox_c, checkbox_u];

            // loaded unique objects - objekt vsetkych unikatnych objektov s loadnutymi obrazkami
            var luo = {};

            // loadnutie obrazkov pre vsetky objekty naraz
            Promise
                .all(objects.map(i => loadImage(i)))
                .then((objects) => {
                    objects.forEach((obj) => { // pre kazdy objekt
                        luo[obj.id] = obj;
                    });
                    // teraz spustame gameLoop
                    runGame();
                }).catch((err) => {
                    console.error(err);
                });

            // tu mame funkcie na vykreslovanie jednotlivych objektov
            // Pozadie
            function drawLandscape1() {
                buffer.drawImage(luo.landscape1.img, 0, 0, luo.landscape1.width, luo.landscape1.height, 0, 0, buffer.canvas.width, buffer.canvas.height);
            }

            // Generuj Moorhunov
            function generateMoorhuhns() {
                if(gameState === GAMESTATE.PAUSED) { return false; }
                // zvysujeme pocet povolenych moorhuhnov na vykreslenie postupne s ubudajucim casom
                moorhuhnAmountMax = (moorhuhnAmountMax + 0.1) * (1 + moorhuhnK / 10000);
                if(moorhuhnAmountMax > moorhuhnMax) { moorhuhnAmountMax = moorhuhnMax; } // mame limit pre maximalny pocet moorhuhnov

                // zistime ci mame pridat na vykreslenie dalsieho moorhuhna
                if(Math.trunc(moorhuhnAmountMax) - _.size(moorhuhns) >= 1) {
                    // nahodne vyber typ moorhuhna a vygeneruj noveho ako kopiu
                    var rm = moorhuhnTypes[Math.floor(Math.random() * moorhuhnTypes.length)]; // rm - random moorhuhn
                    var luoM = luo[rm.id];
                    // nove id
                    id_log += 1; var m_id = id_log;
                    var newMoorhuhnFlying = new MoorhuhnFlying(m_id, luoM.d, context.canvas.width, context.canvas.height, luoM.imgSrc, luoM.imgDeadSrc, luoM.img, luoM.imgDead); // uz vygenerovane obrazky len posunieme novemu moorhuhnovi
                    moorhuhns[m_id] = newMoorhuhnFlying;
                }
            }

            // Priprava na mazanie Moorhuhnov. Ulozia sa do objektu na zmazanie a
            // zmazu sa vo funkcii na zmazanie vsetkych mrtvych Moorhuhnov
            function deleteMoorhuhns() {
                var toDelete = {};

                for(var id in moorhuhns) {
                    var moorhuhn = moorhuhns[id];
                    if(moorhuhn.isDead === true) {
                        toDelete[id] = id;
                    }
                }

                for(var id in toDelete) {
                    delete moorhuhns[id];
                }

                return false;
            }

            // Vymazanie Moorhuhnov po skonceni zomierajucej animacie
            function deleteAllMoorhuhns() {
                var toDelete = {};

                for(var id in moorhuhns) {
                    var moorhuhn = moorhuhns[id];
                    toDelete[id] = id;
                }

                for(var id in toDelete) {
                    delete moorhuhns[id];
                }

                return false;
            }

            // Moorhuhni
            function drawMoorhuhns() {
                // vymaz vsetkych moorhuhnov co cakaju na vymazanie
                deleteMoorhuhns();

                // usporiadame moorhuhnov v objekte podla ich velkosti, aby sa vzdy vykreslil mensi morhuhn za vacsim
                var moorhuhnsV = Object.values(moorhuhns);
                moorhuhnsSorted = moorhuhnsV.sort( compare ); // 'compare' je callback funkcie ktoru sme definovali uplne hore medzi pomocnymi funkciami

                // po usporiadani ich po jednom vykreslime
                moorhuhnsSorted.forEach(function (item, index) {
                    var moorhuhnS = moorhuhnsSorted[index];
                    var moorhuhn = moorhuhns[moorhuhnS.id];

                    if(typeof moorhuhn !== 'undefined') {
                        var res = moorhuhn.updatePosition(); // pohyb moorhuhna
                        var res2 = moorhuhn.updateAnimation();

                        if(moorhuhn.isDead == false) {
                            // vykreslenie moorhuhna
                            buffer.drawImage(moorhuhn.useImg, moorhuhn.spriteX, moorhuhn.spriteY, moorhuhn.spriteWidth, moorhuhn.spriteHeight, moorhuhn.x, moorhuhn.y, moorhuhn.width, moorhuhn.height);
                        }
                    }
                });
            }

            // Timer
            function drawCountdown() {
                // vykresli minuty
                buffer.drawImage(countdown.img, countdown.min.spriteX, countdown.min.spriteY, countdown.spriteWidth, countdown.spriteHeight, countdown.min.x, countdown.min.y, countdown.width, countdown.height);

                // vykresli sekundy desiatky
                buffer.drawImage(countdown.img, countdown.secT.spriteX, countdown.secT.spriteY, countdown.spriteWidth, countdown.spriteHeight, countdown.secT.x, countdown.secT.y, countdown.width, countdown.height);

                // vykresli sekundy jednotky
                buffer.drawImage(countdown.img, countdown.sec.spriteX, countdown.sec.spriteY, countdown.spriteWidth, countdown.spriteHeight, countdown.sec.x, countdown.sec.y, countdown.width, countdown.height);
            }

            // Score
            function drawScore() {
                // vykresli kazdu cifru score od posledneho zprava dolava
                score.ciphersRev.forEach(function (item, index) {
                    var cipher = item;
                    var spriteX = 0;
                    var spriteY = item * score.spriteHeight;
                    var x = width - 20 - (index * score.width + score.width);
                    var y = 20;

                    // vykreslujeme
                    buffer.drawImage(score.img, spriteX, spriteY, score.spriteWidth, score.spriteHeight, x, y, score.width, score.height);
                });
            }

            // Ammo
            function drawAmmo() {
                // mame len jeden sprite, pozicie x a y su 0
                var spriteX = 0;
                var spriteY = 0;

                // var y = context.canvas.width - 20 - context.canvas.height;
                var y = context.canvas.height - 20 - ammo.height;

                // vykresli kazdy naboj v zasobniku
                for(var i = 1; i <= ammo.magazine; i++) { // for mozeme robit aj odpocitavanim, co je lepsie pre performance
                    var x = width - 20 - (i * ammo.width);
                    if(i > 0) { x += -5 * i; } // 5 // okrem prveho cisla zprava, kazdemu dalsiemu pridaj medzeru // bez medzery to vyzera lepsie
                    buffer.drawImage(ammo.img, spriteX, spriteY, ammo.spriteWidth, ammo.spriteHeight, x, y, ammo.width, ammo.height);
                }
            }

            // HUD (Heads-Up Display)
            function drawHud() {
                // timer
                drawCountdown();

                // score
                drawScore();

                // ammo
                drawAmmo();
            }

            // Mieridlo
            function drawCrosshair() {
                buffer.drawImage(crosshair.img, crosshair.x, crosshair.y, crosshair.width, crosshair.height);
            }

            // zastavime vsetkych moorhuhnov
            function pauseMoorhuhns() {
                for(var i in moorhuhns) {
                    var moorhuhn = moorhuhns[i];
                    moorhuhn.pause();
                }
            }

            // Pokracovanie animacie a pohybu Moorhuhnov
            function resumeMoorhuhns() {
                for(var i in moorhuhns) {
                    var moorhuhn = moorhuhns[i];
                    moorhuhn.resume();
                }
            }

            // Zastavime dianie v leveli
            function stopLevel() {
                pauseMoorhuhns();
            }

            // Vystrelenie
            function shoot(x, y) {
                // ak mame prazdny zasobnik, nerob nic
                if(ammo.isMagazineEmpty()) { return false; }

                soundPool.playShoot();

                // ak je stopnuty timer, tak nerob nic
                if(countdown.active === false) { return false; }

                // odober naboj zo zasobnika
                ammo.updateMagazine(-1);

                // zorad moorhuhnov descending podla velkosti, aby trafeny bol vzdy moorhuhn vykresleny blizsie ak su v zakryte
                var mDesc = moorhuhnsSorted;
                mDesc.sort(function(a, b){return b-a});

                // prejdi vsetkych vykreslenych moorhuhnov a zisti ci bolo kliknute na poziciu niektoreho z nich
                for (i = 0; i < mDesc.length; i++) {
                    var moorhuhn = moorhuhns[mDesc[i].id];
                    if(typeof moorhuhn === 'undefined') { return false; }
                    if(moorhuhn.x <= x && x <= moorhuhn.x + moorhuhn.width && moorhuhn.y <= y && y <= moorhuhn.y + moorhuhn.height) {
                        if(moorhuhn.moorhuhnHit === true) { return false; } // ak uz moorhuhn zomiera, nerob nic
                        moorhuhn.moorhuhnShot();
                        score.updateScore(moorhuhn.points);
                        return false; // zasiahli sme moorhuhna, ukonci hladanie trafeneho
                    }
                };
            };

            // funkcia na odpocitavanie casu
            function runTimer() {
                if(countdown.active == true) { return false; } // ak uz bezi, nespusti ho znovu
                countdown.active = true;

                var timerInterval = window.setInterval( function() {
                    // kazdu sekundu pregeneruj moorhuhnov na zobrazenie
                    if(gameState === GAMESTATE.RUNNING) {
                        generateMoorhuhns();
                        if(countdown.time > 0) { countdown.updateTime(-1); }
                    }
                }, 1000);

                if(countdown.time <= 0) { clearInterval(timerInterval); }
            }

            // Herny loop
            function level1() { // tu sa deje vsetko
                soundPool.playLevel_1();

                // spustime odpocitavanie
                runTimer();

                // vykresli pozadie
                drawLandscape1();

                // vykresli moorhuhnov
                drawMoorhuhns();

                // vykresli HUD
                drawHud();

                if(countdown.time <= 0) { // casomiera skoncila
                    gameOver();
                }
            }

            // Intro - musi byt spustene na zacchytenie prveho vstupu uzivatela.
            // !!! Audio subory sa nesmu spustat pred prvym vstupom od uzivatela !!!
            function intro() {
                // Vykresli pozadie
                drawLandscape1();

                // Vykresli sedy overlay
                drawGreyOverlay();

                // Vykresli text
                pressAnyKeyText();
            }

            // Prvy vstup od uzivatela
            function pressAnyKeyText() {
                buffer.font = buttons.size * 1.4 + "px Gomarice";
                buffer.fillStyle = colors.color_passive;
                buffer.textBaseline = 'top';
                buffer.textAlign = 'center';
                buffer.fillText('Press Any Key', width/2, height/2 - buttons.size * 1.4 / 2); // y = 150

                return false;
            }

            // Game Over obrazovka
            function gameOver() {
                soundPool.playGameOver();

                // gamePage = GAMEPAGE.GAME_OVER;
                gameState = GAMESTATE.STOPPED;

                // zastav cele diane v leveli
                stopLevel();

                // vykresli Game Over overlay
                drawGameOver();
            }

            // Vykresli Game Over obrazovku
            function drawGameOver() {
                // Sedy overlay
                drawGreyOverlay();

                // Nadpis
                headingText();

                // Game Over text
                gameOverText();

                // Score
                scoreText();

                // Continue button
                continueText();
            }

            // Click na pokracovanie v Game Over obrazovke
            function continueClick(clientX, clientY) {
                var button = buttons.game_over.continue;
                if(clientX >= button.cx && clientX <= button.cx + button.w && clientY >= button.y && clientY <= button.y + button.h) {
                    gameState = GAMESTATE.MENU;
                }
            }

            // Click v hlavnom Menu obrazovke
            function menuOnClick(clientX, clientY) {
                soundPool.playShoot();
                for(var buttonName in buttons.menu) {
                    var button = buttons.menu[buttonName];
                    // console.log('('+clientX + '  ' +clientY + ') '+button.cx+' '+button.y);
                    // console.log(buttonName);
                    if(clientX >= button.cx && clientX <= button.cx + button.w && clientY >= button.y && clientY <= button.y + button.h) {
                        switch (buttonName) {
                            case 'start':
                                resetLevel();
                                gameState = GAMESTATE.RUNNING;
                                break;
                            case 'about':
                                gameState = GAMESTATE.ABOUT;
                                break;
                            case 'settings':
                                gameState = GAMESTATE.SETTINGS;
                                break;
                            default:
                                break;
                        }
                        return false;
                    }
                }
            }

            // Click na buttony v Menu --> Settings
            function settingsOnClick(clientX, clientY) {
                soundPool.playShoot();
                for(var buttonName in buttons.menu.settings.b) {
                    var button = buttons.menu.settings.b[buttonName];
                    // console.log('('+clientX + '  ' +clientY + ') '+button.cx+' '+button.y);
                    if(clientX >= button.cx && clientX <= button.cx + button.w && clientY >= button.y && clientY <= button.y + button.h) {
                        // console.log(buttonName);
                        switch (buttonName) {
                            case 'fullscreen':
                                SETTINGS.FULLSCREEN = !SETTINGS.FULLSCREEN;
                                if(SETTINGS.FULLSCREEN === true) {
                                    openFullscreen();
                                } else {
                                    closeFullscreen();
                                }
                                break;
                            case 'audio':
                                SETTINGS.AUDIO = !SETTINGS.AUDIO;
                                if(SETTINGS.AUDIO === false) {
                                    soundPool.mute();
                                }
                                break;
                            case 'back':
                                gameState = GAMESTATE.MENU;
                                break;
                            default:
                                break;
                        }
                        return false;
                    }
                }
            }

            // Click v Menu --> About
            function aboutOnClick(clientX, clientY) {
                soundPool.playShoot();
                for(var buttonName in buttons.menu.about.b) {
                    var button = buttons.menu.about.b[buttonName];
                    if(clientX >= button.cx && clientX <= button.cx + button.w && clientY >= button.y && clientY <= button.y + button.h) {
                        switch (buttonName) {
                            case 'back':
                                gameState = GAMESTATE.MENU;
                                break;
                            default:
                                break;
                        }
                        return false;
                    }
                }
            }

            // Zachytenie document elementu - na vyvolanie fullscreenu
            var docEle = document.documentElement;

            // Zapni fullscreen
            function openFullscreen() {
                if (docEle.requestFullscreen) {
                    docEle.requestFullscreen();
                } else if (docEle.mozRequestFullScreen) { /* Firefox */
                    docEle.mozRequestFullScreen();
                } else if (docEle.webkitRequestFullscreen) { /* Chrome, Safari and Opera */
                    docEle.webkitRequestFullscreen();
                } else if (docEle.msRequestFullscreen) { /* IE/Edge */
                    docEle.msRequestFullscreen();
                }
            }

            // Vypni fullscreen
            function closeFullscreen() {
                if (document.exitFullscreen) {
                    document.exitFullscreen();
                } else if (document.mozCancelFullScreen) { /* Firefox */
                    document.mozCancelFullScreen();
                } else if (document.webkitExitFullscreen) { /* Chrome, Safari and Opera */
                    document.webkitExitFullscreen();
                } else if (document.msExitFullscreen) { /* IE/Edge */
                    document.msExitFullscreen();
                }
            }

            // Resetovanie Levelu 1 - Po clicknuti na Continue v Game Over obrazovke
            function resetLevel() {
                countdown.initTime();
                score.initScore();
                ammo.magazine = 5;
                deleteAllMoorhuhns();
                moorhuns = {};
                moorhuhnsSorted = [];
                moorhuhnAmountMax = 1;
                moorhuhnK = 60;
                id_log = 0;
                soundPool.sounds.game_over.played = false;
            }

            // Nadpis - "Moorhuhn Texas"
            function headingText() {
                buffer.font = buttons.heading.h + "px Gomarice";
                buffer.fillStyle = colors.color_active;
                buffer.textBaseline = 'top';
                buffer.textAlign = 'center';
                buffer.fillText('Moorhuhn Texas', buttons.heading.x, buttons.heading.y);

                return false;
            }

            // Sedy overlay - pouzivany vsade okrem beziaceho levelu
            function drawGreyOverlay() {
                buffer.fillStyle = "rgba(32, 45, 21, 0.3)";
                buffer.fillRect(0, 0, width, height);

                return false;
            }

            // Text Game Over v Game Over obrazovke
            function gameOverText() {
                buffer.font = buttons.heading.h + "px Gomarice";
                buffer.fillStyle = '#D95044';
                buffer.textBaseline = 'top';
                buffer.textAlign = 'center';
                buffer.fillText('Game Over', width/2, 150);

                return false;
            }

            // Text Score v Game Over obrazovke
            function scoreText() {
                buffer.font = buttons.size + "px Gomarice";
                buffer.fillStyle = '#39D631';
                buffer.textBaseline = 'top';
                buffer.textAlign = 'center';
                buffer.fillText('Score: ' + score.points, width/2, 230);

                return false;
            }

            // Text Continue v Game Over obrazovke
            function continueText() {
                buffer.font = buttons.size + "px Gomarice";
                buffer.fillStyle = colors.color_passive;
                buffer.textBaseline = 'top';
                buffer.textAlign = 'center';
                buffer.fillText('Continue', buttons.game_over.continue.x, buttons.game_over.continue.y);

                return false;
            }

            // Obrazovka Menu
            function menu() {
                if(gameState === GAMESTATE.MENU) {
                    soundPool.playMenu();
                }

                if(PAUSED == false) {
                    drawLandscape1();
                }

                drawGreyOverlay();

                headingText();

                // Buttony
                buffer.font = buttons.size + "px Gomarice";
                buffer.fillStyle = colors.color_passive;
                buffer.textBaseline = 'top';
                buffer.textAlign = 'center';

                buffer.fillText('Start', buttons.menu.start.x, buttons.menu.start.y); // y 150

                buffer.fillText('About', buttons.menu.about.x, buttons.menu.about.y); // y 230

                buffer.fillText('Settings', buttons.menu.settings.x, buttons.menu.settings.y);
            }

            // Click na Menu --> About
            function about() {
                if(PAUSED == false) {
                    drawLandscape1();
                }

                drawGreyOverlay();

                headingText();

                // Key Bindings
                // ESC
                buffer.font = texts.about.key_bindings.esc.h + "px Gomarice";
                buffer.fillStyle = colors.color_active;
                buffer.textAlign = 'end';
                buffer.fillText('ESC', texts.about.key_bindings.esc.x, texts.about.key_bindings.esc.y);
                // ESC text
                buffer.font = texts.about.key_bindings.esc_text.h + "px Gomarice";
                buffer.fillStyle = colors.color_passive;
                buffer.textAlign = 'start';
                buffer.fillText(' - Exit Fullscreen', texts.about.key_bindings.esc_text.x, texts.about.key_bindings.esc_text.y);

                // P
                buffer.font = texts.about.key_bindings.p.h + "px Gomarice";
                buffer.fillStyle = colors.color_active;
                buffer.textAlign = 'end';
                buffer.fillText('P', texts.about.key_bindings.p.x, texts.about.key_bindings.p.y);
                // P text
                buffer.font = texts.about.key_bindings.p_text.h + "px Gomarice";
                buffer.fillStyle = colors.color_passive;
                buffer.textAlign = 'start';
                buffer.fillText(' - Pause / unpause game', texts.about.key_bindings.p_text.x, texts.about.key_bindings.p_text.y);

                // Left Click
                buffer.font = texts.about.key_bindings.left_click.h + "px Gomarice";
                buffer.fillStyle = colors.color_active;
                buffer.textAlign = 'end';
                buffer.fillText('Left Click', texts.about.key_bindings.left_click.x, texts.about.key_bindings.left_click.y);
                // Left Click text
                buffer.font = texts.about.key_bindings.left_click_text.h + "px Gomarice";
                buffer.fillStyle = colors.color_passive;
                buffer.textAlign = 'start';
                buffer.fillText(' - Shoot', texts.about.key_bindings.left_click_text.x, texts.about.key_bindings.left_click_text.y);

                // Space
                buffer.font = texts.about.key_bindings.space.h + "px Gomarice";
                buffer.fillStyle = colors.color_active;
                buffer.textAlign = 'end';
                buffer.fillText('Space', texts.about.key_bindings.space.x, texts.about.key_bindings.space.y);
                // Space text
                buffer.font = texts.about.key_bindings.space_text.h + "px Gomarice";
                buffer.fillStyle = colors.color_passive;
                buffer.textAlign = 'start';
                buffer.fillText(' - Reload Magazine - Can be reloaded at any time', texts.about.key_bindings.space_text.x, texts.about.key_bindings.space_text.y);

                // Moorhuhn
                buffer.font = texts.about.key_bindings.moorhuhn.h + "px Gomarice";
                buffer.fillStyle = colors.color_passive;
                buffer.textAlign = 'center';
                buffer.fillText('Moorhuhn', texts.about.key_bindings.moorhuhn.x, texts.about.key_bindings.moorhuhn.y);
                // Moorhuhn image


                // Moorhuhn shot
                buffer.font = texts.about.key_bindings.moorhuhn_shot.h + "px Gomarice";
                buffer.fillStyle = colors.color_passive;
                buffer.textAlign = 'center';
                buffer.fillText('Moorhuhn hit', texts.about.key_bindings.moorhuhn_shot.x, texts.about.key_bindings.moorhuhn_shot.y);
                // Moorhuhn shot image


                // Magazine
                buffer.font = texts.about.key_bindings.magazine.h + "px Gomarice";
                buffer.fillStyle = colors.color_passive;
                buffer.textAlign = 'center';
                buffer.fillText('Magazine', texts.about.key_bindings.magazine.x, texts.about.key_bindings.magazine.y);
                // Magazine image


                // Back
                buffer.font = buttons.size + "px Gomarice";
                buffer.fillStyle = colors.color_passive;
                buffer.textAlign = 'center';
                buffer.fillText('Back', buttons.menu.about.b.back.x, buttons.menu.about.b.back.y);
            }

            // Click na Menu --> Settings
            function settings() {
                if(PAUSED == false) {
                    drawLandscape1();
                }

                drawGreyOverlay();

                headingText();

                // Buttony
                buffer.font = buttons.size + "px Gomarice";
                buffer.fillStyle = colors.color_passive;
                buffer.textBaseline = 'top';
                buffer.textAlign = 'end';

                // Text
                buffer.fillText('Audio', buttons.menu.settings.b.audio.x, buttons.menu.settings.b.audio.y);
                // Checkbox
                if(SETTINGS.AUDIO == true) { // Checked
                    buffer.drawImage(checkbox_c.img, buttons.menu.settings.b.audio.bx, buttons.menu.settings.b.audio.by, buttons.menu.settings.b.audio.bw, buttons.menu.settings.b.audio.bh);
                } else { // Unchecked
                    buffer.drawImage(checkbox_u.img, buttons.menu.settings.b.audio.bx, buttons.menu.settings.b.audio.by, buttons.menu.settings.b.audio.bw, buttons.menu.settings.b.audio.bh);
                }

                // Text
                buffer.fillText('Fullscreen', buttons.menu.settings.b.fullscreen.x, buttons.menu.settings.b.fullscreen.y);
                // Checkbox
                if(SETTINGS.FULLSCREEN == true) { // Checked
                    buffer.drawImage(checkbox_c.img, buttons.menu.settings.b.fullscreen.bx, buttons.menu.settings.b.fullscreen.by, buttons.menu.settings.b.fullscreen.bw, buttons.menu.settings.b.fullscreen.bh);
                } else { // Unchecked
                    buffer.drawImage(checkbox_u.img, buttons.menu.settings.b.fullscreen.bx, buttons.menu.settings.b.fullscreen.by, buttons.menu.settings.b.fullscreen.bw, buttons.menu.settings.b.fullscreen.bh);
                }

                buffer.textAlign = 'center';

                // Back
                buffer.fillText('Back', buttons.menu.settings.b.back.x, buttons.menu.settings.b.back.y);
            }

            // Stlacenie klavesy pre pauznutie levelu
            function pauseGame() {
                gameState = GAMESTATE.PAUSED;
                PAUSED = true;
                pauseMoorhuhns();
            }

            // Pokracovanie v leveli
            function resumeGame() {
                gameState = GAMESTATE.RUNNING;
                PAUSED = false;
                resumeMoorhuhns();
            }

            // Vycistenie bufferu a canvasu po vykresleni kazdej iteracie
            function clear() {
                buffer.clearRect(0, 0, width, height);
                context.clearRect(0, 0, width, height);

                return false;
            }

            function updateCheckboxes() {
                checkbox_c.setDimensions(buttons.size);
                checkbox_u.setDimensions(buttons.size);
            }

            // Game Loop
            function runGame() {
                clear();

                // poistka pri developmente - ak dosiahne zadanu iteraciu, herny loop sa zastavi
                // ak je kod zle navrhnuty, moze pretiect pamatovy zasobnik a zhodime hru / prehliadac
                gameLoop_i += 1; // pocitame iteracie herneho loopu
                if(gameLoop_i == 10000) {  // zastavenie loopu na testovanie pocas developmentu
                    // return false; // po returne sa funkcia ukonci, loop sa zastavi
                    gameLoop_i = 0;
                }

                // v pripade zmeny rozlisenia, sa zmena detekuje v gameLoope a zmeni sa rozmer canvasu
                height = document.documentElement.clientHeight;
                width = document.documentElement.clientWidth;

                // tu urcime velkost podla landscape1 aspect ratio
                height = width / landscape1.aspectRatio;

                // buffer
                buffer.canvas.height = height;
                buffer.canvas.width = width;

                // context
                context.canvas.height = height;
                context.canvas.width = width;

                // vypnute | zapnute automaticke vyhladzovanie obrazkov
                buffer.imageSmoothingEnabled = true;
                context.imageSmoothingEnabled = true;

                if(gameState !== GAMESTATE.RUNNING) {
                    calcButtons(); // vypocitaj dimenzie pre tlacitka
                    updateCheckboxes(); // vypocitaj dimenzie pre checkboxy
                    calcTexts(); // vypocitaj dimenzie pre texty
                }

                if(gameState == GAMESTATE.INTRO) {
                    intro();
                }

                // if(gameState == GAMESTATE.RUNNING || gameState == GAMESTATE.PAUSED || gameState == GAMESTATE.GAME_OVER) {
                if(gameState == GAMESTATE.RUNNING || gameState == GAMESTATE.PAUSED || gameState == GAMESTATE.GAME_OVER || PAUSED == true) {
                    level1();
                }

                if(gameState == GAMESTATE.ABOUT) {
                    about();
                }

                if(gameState == GAMESTATE.SETTINGS) {
                    settings();
                }

                if(gameState == GAMESTATE.PAUSED || gameState == GAMESTATE.MENU) {
                    menu();
                }

                if(gameState == GAMESTATE.GAME_OVER) {
                    gameOver();
                }

                drawCrosshair();

                context.drawImage(buffer.canvas, 0, 0, buffer.canvas.width, buffer.canvas.height, 0, 0, context.canvas.width, context.canvas.height);

                window.requestAnimationFrame(runGame);
            }

        </script>

    </body>
</html>
